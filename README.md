# canvas
#http://git.oschina.net/gangtao/FlowChart-Builder
(function(){varcount=0;vardraggingAnchor={'isDragging':false,'sourceId':''};functionaddNode(nodeInfo){varparentId=nodeInfo.parentId,nodeId=nodeInfo.nodeId,shape=nodeInfo.shape,nodeLabel=nodeInfo.nodeLabel,position=nodeInfo.position,groupName=nodeInfo.groupName,backgroudColor=nodeInfo.backgroudColor,borderColor=nodeInfo.borderColor;if(parentId&&nodeId&&nodeLabel&&position&&groupName){switch(shape){case'rect':node=flowChart.addRectNode(parentId,nodeId,nodeLabel,{x:position.x,y:position.y},groupName,shape,backgroudColor,borderColor);break;case'circle':node=flowChart.addCircleNode(parentId,nodeId,nodeLabel,{x:position.x,y:position.y},groupName,shape,backgroudColor,borderColor);break;case'diamand':node=flowChart.addDiamandNode(parentId,nodeId,nodeLabel,{x:position.x,y:position.y},groupName,shape,backgroudColor,borderColor);break;default:node=flowChart.addRectNode(parentId,nodeId,nodeLabel,{x:position.x,y:position.y},groupName,shape,backgroudColor,borderColor);break;}returnjsPlumb.getSelector('#'+nodeId)[0];}}functionaddDiamandNode(parentId,nodeId,nodeLabel,position,groupName,shape){varpanel=d3.select("#"+parentId);panel.append('div').style('width','120px').style('height','80px').style('position','absolute').style('top',position.y).style('left',position.x)//.style('border','2px#9DFFCAsolid').attr('align','center').attr('id',nodeId).attr('class','diamand').attr('key',count++).attr('group',groupName).attr('shape',shape).classed('node',true).append('div').text(nodeLabel);returnjsPlumb.getSelector('#'+nodeId)[0];}functionaddRectNode(parentId,nodeId,nodeLabel,position,groupName,shape){varpanel=d3.select("#"+parentId);panel.append('div').style('width','120px').style('height','50px').style('position','absolute').style('top',position.y).style('left',position.x).style('border','2px#9DFFCAsolid').style('border-radius','10px').attr('align','center').attr('id',nodeId).attr('class','rect').attr('key',count++).attr('group',groupName).attr('shape',shape).classed('node',true).append('div').text(nodeLabel);returnjsPlumb.getSelector('#'+nodeId)[0];}functionaddCircleNode(parentId,nodeId,nodeLabel,position,groupName,shape){varpanel=d3.select("#"+parentId);panel.append('div').style('width','80px').style('height','80px').style('position','absolute').style('top',position.y).style('left',position.x).style('border','2px#9DFFCAsolid').style('border-radius','40px').attr('align','center').attr('class','circle').attr('key',count++).attr('group',groupName).attr('shape',shape).attr('id',nodeId).classed('node',true).append('div').text(nodeLabel);returnjsPlumb.getSelector('#'+nodeId)[0];}functionaddPorts(instance,node,ports,type,maxConnections){//Assumehorizentallayoutvarnumber_of_ports=ports.length;vari=0;varheight=$(node).height();//Note,jquerydoesnotincludeborderforheightvary_offset=1/(number_of_ports+1);vary=0;for(;i<number_of_ports;i++){varanchor=[0,0,0,0];varpaintStyle={radius:5,fillStyle:'#FF8891'};varisSource=false,isTarget=false;if(type==='output'){anchor[0]=1;paintStyle.fillStyle='#D4FFD6';isSource=true;}else{isTarget=true;}anchor[1]=y+y_offset;y=anchor[1];instance.addEndpoint(node,{uuid:node.id+"-"+ports[i],paintStyle:paintStyle,anchor:anchor,maxConnections:maxConnections!==undefined?maxConnections:-1,isSource:isSource,isTarget:isTarget});}}functionconnectPorts(instance,node1,port1,node2,port2){//declaresomecommonvalues:varcolor="gray";vararrowCommon={foldback:0.8,fillStyle:color,width:5};//usethree-argspectocreatetwodifferentarrowswiththecommonvalues://overlays=[//["plainArrow",{location:0.8},arrowCommon],//["plainArrow",{location:0.2,direction:-1},arrowCommon]//];varuuid_source=node1.getAttribute("id")+"-"+port1;varuuid_target=node2.getAttribute("id")+"-"+port2;instance.connect({uuids:[uuid_source,uuid_target]});}functiongetTreeData(){vartree=[{text:"通用",icon:'',nodes:[{text:"定时触发器",shape:'circle',maxConnections:2},{text:"消息触发器",shape:'diamand',maxConnections:2},{text:"空触发器",shape:'circle',maxConnections:2},{text:"分支",shape:'diamand',maxConnections:2}]},{text:"数据接入",nodes:[{text:"ERP",shape:'rect',maxConnections:2},{text:"SCM",shape:'rect',maxConnections:2},{text:"EFIN_HANA",shape:'rect',maxConnections:2}]},{text:"算子",nodes:[{text:"SQL",shape:'rect',maxConnections:2},{text:"JOIN",shape:'rect',maxConnections:2}]}];returntree;}functionchangeNodeName(id,name){$('#'+id+'div').text(name);showJson(jsPlumb.getInstance());}functiondeleteNode(instance,nodeId){varconnections=instance.getAllConnections();connections.forEach(function(item,index){if(item.sourceId==='nodeId'||item.targetId===nodeId){this.detach(item);}},instance);instance.getSelector('#'+nodeId).detach();instance.getEndpoint(nodeId+'-in').canvas.remove();instance.getEndpoint(nodeId+'-out').canvas.remove();flowChart.showJson(instance);flowChart.closeDialog();}functionsetSideBarContent(id,data){$('#'+id).treeview({data:data});}functionshowJson(instance){varconnections=instance.getAllConnections();varlinkDataArray=connections.map(function(item,index){varsourceId=item.sourceId;vartargetId=item.targetId;return{"from":sourceId,"to":targetId,"fromPort":"B","toPort":"T"};});varnodeDataArray=[];$('.node').each(function(index,item){nodeDataArray.push({id:item.id,"class":item.className,text:item.textContent,loc:$(item).position(),group:item.getAttribute('group')});});varjsonResult={linkDataArray:linkDataArray,nodeDataArray:nodeDataArray};$('#json-result').val(JSON.stringify(jsonResult,null,4));}functioncloseDialog(){$('.modal-backdrop').click();}functionsubmitChange(){varfocusNode=localStorage.getItem('focusNode');focusNode=JSON.parse(focusNode);varname=$('#dialog-name').val();varid=focusNode.id;flowChart.changeNodeName(id,name);}functioninitEventListener(instance){$('.node').mouseover(function(evt){$('circle').css('visibility','visible');if(draggingAnchor.isDragging){console.log(draggingAnchor);draggingAnchor.isDragging=false;varsource=jsPlumb.getSelector('#'+draggingAnchor.sourceId)[0];vartargetId=evt.target.id===''?evt.target.parentNode.id:evt.target.id;vartarget=jsPlumb.getSelector('#'+targetId)[0];connectPorts(instance,source,'out',target,'in');}});$('.node').mouseout(function(evt){$('circle').css('visibility','hidden');});$('.node').on('dragstop',function(evt){showJson(instance);});$('.node').mouseup(function(evt){//console.log(evt);});$('.node').dblclick(function(evt){varnode;if(evt.target.id!==''){node=evt.target;}else{node=evt.target.parentNode;}vargroup=$(node).attr('group');varid=node.id;varfocusNodeInfo={group:group,id:id};localStorage.setItem('focusNode',JSON.stringify(focusNodeInfo));$('#myModal').modal({keyboard:true});$('#dialog-name').val(node.textContent);});$('#delete-node').click(function(evt){varfocusNode=localStorage.getItem('focusNode');varnodeId=JSON.parse(focusNode).id;flowChart.deleteNode(instance,nodeId);});$('#submit-change').click(function(){flowChart.submitChange();flowChart.closeDialog();});}functionsearchDataById(id){treeData.forEach(function(item,index){item.nodes.forEach(function(node){if(node.id===id){returnnode;}});});}functionsearchDataByText(text){treeData.forEach(function(item,index){item.nodes.forEach(function(node){if(node.text===text){returnnode;}});});}jsPlumb.ready(function(){console.log("jsPlumbisreadytouse");//InitializeJsPlumbvarcolor="#E8C870";varinstance=jsPlumb.getInstance({//noticethe'curviness'argumenttothisBeziercurve.thecurvesonthispagearefarsmoother//thanthecurvesonthefirstdemo,whichusethedefaultcurvinessvalue.Connector:["Flowchart",{cornerRadius:5}],//["Bezier",{curviness:50}],DragOptions:{cursor:"pointer",zIndex:2000},PaintStyle:{strokeStyle:color,lineWidth:2},EndpointStyle:{radius:5,fillStyle:"transparent"},HoverPaintStyle:{strokeStyle:"#7073EB"},EndpointHoverStyle:{fillStyle:"#7073EB"},Container:"flow-panel",endpoint:"Blank",connector:["Flowchart",{cornerRadius:5}],paintStyle:{strokeWidth:2,stroke:"#f76258",outlineWidth:3,outlineStroke:"transparent"},//paintstyleforthisedgetype.hoverPaintStyle:{strokeWidth:2,stroke:"rgb(67,67,67)"},//hoverpaintstyleforthisedgetype.overlays:[["Arrow",{location:1,width:10,length:10}],["Arrow",{location:0.3,width:10,length:10}]],ConnectionOverlays:[["Arrow",{location:1.0}]//["Label",{//location:0.1,//id:"label",//cssClass:"aLabel"//}]]});//InitializeControlTreeView$('#control-panel').treeview({data:getTreeData()});//Handledraganddrop$('.list-group-item').attr('draggable','true').on('dragstart',function(ev){//ev.dataTransfer.setData("text",ev.target.id);vartreeData=getTreeData();//varnodeObj={};treeData.forEach(function(item,index){item.nodes.forEach(function(node){if(node.text===ev.target.textContent){ev.originalEvent.dataTransfer.setData('nodeInfo',JSON.stringify(node));}});});console.log('dragstart');});//document.styleSheets[3].addRule('circle','visibility:hidden',5)$('#flow-panel').on('drop',function(ev){showJson(instance);//avoideventconlictforjsPlumbif(ev.target.className.indexOf('_jsPlumb')>=0){return;}ev.preventDefault();//GetNodeInfovarnodeLabel=prompt("Pleaseenterthename");varmx=''+ev.originalEvent.offsetX+'px';varmy=''+ev.originalEvent.offsetY+'px';varnodeInfo=ev.originalEvent.dataTransfer.getData('nodeInfo');nodeInfo=JSON.parse(nodeInfo);vargroupName=nodeInfo.text;varnodeShape=nodeInfo.shape;varnode;varuid=newDate().getTime();nodeInfo.parentId='flow-panel';nodeInfo.nodeId='node'+uid;nodeInfo.shape=nodeShape;nodeInfo.nodeLabel=nodeLabel;nodeInfo.groupName=groupName;nodeInfo.position={x:mx,y:my};//CreateNodenode=addNode(nodeInfo);addPorts(instance,node,['out'],'output');addPorts(instance,node,['in'],'input',nodeInfo.maxConnections);instance.draggable($(node));initEventListener(instance);showJson(instance);}).on('dragover',function(ev){ev.preventDefault();//console.log('ondragover');});instance.bind("connectionDrag",function(connection){document.styleSheets[3].addRule('circle','visibility:visible!important',5);});instance.bind("connectionDragStop",function(connection,b,c,d){document.styleSheets[3].deleteRule(5);draggingAnchor.isDragging=true;draggingAnchor.sourceId=connection.sourceId;varifNotInNode=function(){if(draggingAnchor.isDragging){draggingAnchor.isDragging=false;}};setTimeout(ifNotInNode,100);varkey=connection.endpoints[0].element.attributes.key;varid=connection.endpoints[0].element.attributes.id;varClass=connection.endpoints[0].element.attributes['class'].valueOf;vartext=connection.endpoints[0].element.textContent;varposition=$(connection.endpoints[0].element).position();});instance.bind("connectionMoved",function(params){//console.log("connection"+params.connection.id+"wasmoved");});instance.bind("click",function(conn,originalEvent){if(confirm("Deleteconnectionfrom"+conn.sourceId+"to"+conn.targetId+"?")){instance.detach(conn);conn.toggleType("basic");}});instance.bind("mouseover",function(evt){$('circle').css('visibility','visible');});instance.bind("mouseout",function(evt){$('circle').css('visibility','hidden');});instance.doWhileSuspended(function(){//declaresomecommonvalues:vararrowCommon={foldback:0.8,fillStyle:color,width:5},//usethree-argspectocreatetwodifferentarrowswiththecommonvalues:overlays=[["plainArrow",{location:0.8},arrowCommon],["plainArrow",{location:0.2,direction:-1},arrowCommon]];varnode1=addRectNode('flow-panel','node1','node1',{x:'80px',y:'20px'},'ERP');varnode2=addRectNode('flow-panel','node2','node2',{x:'280px',y:'20px'},'ERP');//addPorts(instance,node1,['out1','out2'],'output');//addPorts(instance,node2,['in','in1','in2'],'input');//connectPorts(instance,node1,'out2',node2,'in');addPorts(instance,node1,['in'],'input');addPorts(instance,node1,['out'],'output');addPorts(instance,node2,['in'],'input');addPorts(instance,node2,['out'],'output');connectPorts(instance,node1,'out',node2,'in');instance.draggable($('.node'));initEventListener(instance);});jsPlumb.fire("jsFlowLoaded",instance);});window.flowChart={addNode:addNode,addDiamandNode:addDiamandNode,addRectNode:addRectNode,addCircleNode:addCircleNode,addPorts:addPorts,connectPorts:connectPorts,showJson:showJson,setSideBarContent:setSideBarContent,submitChange:submitChange,changeNodeName:changeNodeName,closeDialog:closeDialog,deleteNode:deleteNode,searchDataById:searchDataById,searchDataByText:searchDataByText};})();
