# canvas
#http://git.oschina.net/gangtao/FlowChart-Builder
!function(){function c(a){var b=a.parentId,c=a.nodeId,d=a.shape,e=a.nodeLabel,f=a.position,g=a.groupName,h=a.backgroudColor,i=a.borderColor;if(b&&c&&e&&f&&g){switch(d){case"rect":node=flowChart.addRectNode(b,c,e,{x:f.x,y:f.y},g,d,h,i);break;case"circle":node=flowChart.addCircleNode(b,c,e,{x:f.x,y:f.y},g,d,h,i);break;case"diamand":node=flowChart.addDiamandNode(b,c,e,{x:f.x,y:f.y},g,d,h,i);break;default:node=flowChart.addRectNode(b,c,e,{x:f.x,y:f.y},g,d,h,i)}return jsPlumb.getSelector("#"+c)[0]}}function d(b,c,d,e,f,g){var h=d3.select("#"+b);return h.append("div").style("width","120px").style("height","80px").style("position","absolute").style("top",e.y).style("left",e.x).attr("align","center").attr("id",c).attr("class","diamand").attr("key",a++).attr("group",f).attr("shape",g).classed("node",!0).append("div").text(d),jsPlumb.getSelector("#"+c)[0]}function e(b,c,d,e,f,g){var h=d3.select("#"+b);return h.append("div").style("width","120px").style("height","50px").style("position","absolute").style("top",e.y).style("left",e.x).style("border","2px #9DFFCA solid").style("border-radius","10px").attr("align","center").attr("id",c).attr("class","rect").attr("key",a++).attr("group",f).attr("shape",g).classed("node",!0).append("div").text(d),jsPlumb.getSelector("#"+c)[0]}function f(b,c,d,e,f,g){var h=d3.select("#"+b);return h.append("div").style("width","80px").style("height","80px").style("position","absolute").style("top",e.y).style("left",e.x).style("border","2px #9DFFCA solid").style("border-radius","40px").attr("align","center").attr("class","circle").attr("key",a++).attr("group",f).attr("shape",g).attr("id",c).classed("node",!0).append("div").text(d),jsPlumb.getSelector("#"+c)[0]}function g(a,b,c,d,e){for(var f=c.length,g=0,i=($(b).height(),1/(f+1)),j=0;g<f;g++){var k=[0,0,0,0],l={radius:5,fillStyle:"#FF8891"},m=!1,n=!1;"output"===d?(k[0]=1,l.fillStyle="#D4FFD6",m=!0):n=!0,k[1]=j+i,j=k[1],a.addEndpoint(b,{uuid:b.id+"-"+c[g],paintStyle:l,anchor:k,maxConnections:void 0!==e?e:-1,isSource:m,isTarget:n})}}function h(a,b,c,d,e){var h=b.getAttribute("id")+"-"+c,i=d.getAttribute("id")+"-"+e;a.connect({uuids:[h,i]})}function i(){var a=[{text:"通用",icon:"",nodes:[{text:"定时触发器",shape:"circle",maxConnections:2},{text:"消息触发器",shape:"diamand",maxConnections:2},{text:"空触发器",shape:"circle",maxConnections:2},{text:"分支",shape:"diamand",maxConnections:2}]},{text:"数据接入",nodes:[{text:"ERP",shape:"rect",maxConnections:2},{text:"SCM",shape:"rect",maxConnections:2},{text:"EFIN_HANA",shape:"rect",maxConnections:2}]},{text:"算子",nodes:[{text:"SQL",shape:"rect",maxConnections:2},{text:"JOIN",shape:"rect",maxConnections:2}]}];return a}function j(a,b){$("#"+a+" div").text(b),m(jsPlumb.getInstance())}function k(a,b){var c=a.getAllConnections();c.forEach(function(a,c){"nodeId"!==a.sourceId&&a.targetId!==b||this.detach(a)},a),a.getSelector("#"+b).detach(),a.getEndpoint(b+"-in").canvas.remove(),a.getEndpoint(b+"-out").canvas.remove(),flowChart.showJson(a),flowChart.closeDialog()}function l(a,b){$("#"+a).treeview({data:b})}function m(a){var b=a.getAllConnections(),c=b.map(function(a,b){var c=a.sourceId,d=a.targetId;return{from:c,to:d,fromPort:"B",toPort:"T"}}),d=[];$(".node").each(function(a,b){d.push({id:b.id,class:b.className,text:b.textContent,loc:$(b).position(),group:b.getAttribute("group")})});var e={linkDataArray:c,nodeDataArray:d};$("#json-result").val(JSON.stringify(e,null,4))}function n(){$(".modal-backdrop").click()}function o(){var a=localStorage.getItem("focusNode");a=JSON.parse(a);var b=$("#dialog-name").val(),c=a.id;flowChart.changeNodeName(c,b)}function p(a){$(".node").mouseover(function(c){if($("circle").css("visibility","visible"),b.isDragging){console.log(b),b.isDragging=!1;var d=jsPlumb.getSelector("#"+b.sourceId)[0],e=""===c.target.id?c.target.parentNode.id:c.target.id,f=jsPlumb.getSelector("#"+e)[0];h(a,d,"out",f,"in")}}),$(".node").mouseout(function(a){$("circle").css("visibility","hidden")}),$(".node").on("dragstop",function(b){m(a)}),$(".node").mouseup(function(a){}),$(".node").dblclick(function(a){var b;b=""!==a.target.id?a.target:a.target.parentNode;var c=$(b).attr("group"),d=b.id,e={group:c,id:d};localStorage.setItem("focusNode",JSON.stringify(e)),$("#myModal").modal({keyboard:!0}),$("#dialog-name").val(b.textContent)}),$("#delete-node").click(function(b){var c=localStorage.getItem("focusNode"),d=JSON.parse(c).id;flowChart.deleteNode(a,d)}),$("#submit-change").click(function(){flowChart.submitChange(),flowChart.closeDialog()})}function q(a){treeData.forEach(function(b,c){b.nodes.forEach(function(b){if(b.id===a)return b})})}function r(a){treeData.forEach(function(b,c){b.nodes.forEach(function(b){if(b.text===a)return b})})}var a=0,b={isDragging:!1,sourceId:""};jsPlumb.ready(function(){console.log("jsPlumb is ready to use");var a="#E8C870",d=jsPlumb.getInstance({Connector:["Flowchart",{cornerRadius:5}],DragOptions:{cursor:"pointer",zIndex:2e3},PaintStyle:{strokeStyle:a,lineWidth:2},EndpointStyle:{radius:5,fillStyle:"transparent"},HoverPaintStyle:{strokeStyle:"#7073EB"},EndpointHoverStyle:{fillStyle:"#7073EB"},Container:"flow-panel",endpoint:"Blank",connector:["Flowchart",{cornerRadius:5}],paintStyle:{strokeWidth:2,stroke:"#f76258",outlineWidth:3,outlineStroke:"transparent"},hoverPaintStyle:{strokeWidth:2,stroke:"rgb(67,67,67)"},overlays:[["Arrow",{location:1,width:10,length:10}],["Arrow",{location:.3,width:10,length:10}]],ConnectionOverlays:[["Arrow",{location:1}]]});$("#control-panel").treeview({data:i()}),$(".list-group-item").attr("draggable","true").on("dragstart",function(a){var b=i();b.forEach(function(b,c){b.nodes.forEach(function(b){b.text===a.target.textContent&&a.originalEvent.dataTransfer.setData("nodeInfo",JSON.stringify(b))})}),console.log("drag start")}),$("#flow-panel").on("drop",function(a){if(m(d),!(a.target.className.indexOf("_jsPlumb")>=0)){a.preventDefault();var b=prompt("Please enter the name"),e=""+a.originalEvent.offsetX+"px",f=""+a.originalEvent.offsetY+"px",h=a.originalEvent.dataTransfer.getData("nodeInfo");h=JSON.parse(h);var k,i=h.text,j=h.shape,l=(new Date).getTime();h.parentId="flow-panel",h.nodeId="node"+l,h.shape=j,h.nodeLabel=b,h.groupName=i,h.position={x:e,y:f},k=c(h),g(d,k,["out"],"output"),g(d,k,["in"],"input",h.maxConnections),d.draggable($(k)),p(d),m(d)}}).on("dragover",function(a){a.preventDefault()}),d.bind("connectionDrag",function(a){document.styleSheets[3].addRule("circle","visibility:visible !important",5)}),d.bind("connectionDragStop",function(a,c,d,e){document.styleSheets[3].deleteRule(5),b.isDragging=!0,b.sourceId=a.sourceId;var f=function(){b.isDragging&&(b.isDragging=!1)};setTimeout(f,100);a.endpoints[0].element.attributes.key,a.endpoints[0].element.attributes.id,a.endpoints[0].element.attributes.class.valueOf,a.endpoints[0].element.textContent,$(a.endpoints[0].element).position()}),d.bind("connectionMoved",function(a){}),d.bind("click",function(a,b){confirm("Delete connection from "+a.sourceId+" to "+a.targetId+"?")&&(d.detach(a),a.toggleType("basic"))}),d.bind("mouseover",function(a){$("circle").css("visibility","visible")}),d.bind("mouseout",function(a){$("circle").css("visibility","hidden")}),d.doWhileSuspended(function(){var f=e("flow-panel","node1","node1",{x:"80px",y:"20px"},"ERP"),i=e("flow-panel","node2","node2",{x:"280px",y:"20px"},"ERP");g(d,f,["in"],"input"),g(d,f,["out"],"output"),g(d,i,["in"],"input"),g(d,i,["out"],"output"),h(d,f,"out",i,"in"),d.draggable($(".node")),p(d)}),jsPlumb.fire("jsFlowLoaded",d)}),window.flowChart={addNode:c,addDiamandNode:d,addRectNode:e,addCircleNode:f,addPorts:g,connectPorts:h,showJson:m,setSideBarContent:l,submitChange:o,changeNodeName:j,closeDialog:n,deleteNode:k,searchDataById:q,searchDataByText:r}}();
